/**
 * moo.meio.mask.min.js
 * @version 1.1.1
 * Copyright (c) 2008 Fabio M. Costa http://www.meiocodigo.com
 * The MIT License (http://www.opensource.org/licenses/mit-license.php)
 */
if(!$defined(meio)){var meio={}}$extend(Element.NativeEvents,{"paste":2,"input":2});Element.Events.paste={base:(Browser.Engine.presto||(Browser.Engine.gecko&&Browser.Engine.version<19))?"input":"paste",condition:function(A){this.fireEvent("paste",A,1);return false}};meio.MaskGlobals=new Hash({init:function(){if(!this.inited){var A=this,B,C=(Browser.Platform.ipod)?this.iphoneKeyRepresentation:this.keyRepresentation;this.setFixedChars(this.fixedChars);for(B=0;B<=9;B++){this.rules[B]=new RegExp("[0-"+B+"]")}this.keyRep=C;this.ignoreKeys=[];Hash.each(C,function(E,D){A.ignoreKeys.push(D.toInt())});this.inited=true}return this},reInit:function(){this.inited=false;return this.init()},setFixedChars:function(A){this.fixedCharsReg=new RegExp(this.fixedChars);this.fixedCharsRegG=new RegExp(this.fixedChars,"g");return this},rules:{"z":/[a-z]/,"Z":/[A-Z]/,"a":/[a-zA-Z]/,"*":/[0-9a-zA-Z]/,"@":/[0-9a-zA-ZçÇáàãéèíìóòõúùü]/},fixedChars:"[(),.:/ -]",keyRepresentation:{8:"backspace",9:"tab",13:"enter",16:"shift",17:"control",18:"alt",27:"esc",33:"page up",34:"page down",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"insert",46:"delete",116:"f5",224:"command"},iphoneKeyRepresentation:{10:"go",127:"delete"},signals:{"+":"","-":"-"},masks:{"phone":{mask:"(99) 9999-9999"},"phone-us":{mask:"(999) 999-9999"},"cpf":{mask:"999.999.999-99"},"cnpj":{mask:"99.999.999/9999-99"},"date":{mask:"39/19/9999"},"date-us":{mask:"19/39/9999"},"cep":{mask:"99999-999"},"time":{mask:"29:59"},"cc":{mask:"9999 9999 9999 9999"},"integer":{mask:"999.999.999.999",type:"reverse"},"decimal":{mask:"99,999.999.999.999",type:"reverse",defaultValue:"000"},"decimal-us":{mask:"99.999,999,999,999",type:"reverse",defaultValue:"000"},"signed-decimal":{mask:"99,999.999.999.999",type:"reverse",defaultValue:"+000"},"signed-decimal-us":{mask:"99,999.999.999.999",type:"reverse",defaultValue:"+000"}}});meio.Mask=new Class({Implements:[Options,Events],options:{attr:"alt",mask:null,type:"fixed"},initialize:function(B,A){this.$el=$(B);if(this.$el.get("tag")!="input"||this.$el.get("type")!="text"){return }this.globals=meio.MaskGlobals.init();this.change(A)},change:function(B){B=$pick(B,{});if(B.attr){this.options.attr=B.attr}var E=this.$el.get(this.options.attr),A;A=($type(B)=="string")?B:(E)?E:null;if(A){this.options.mask=A}if(this.globals.masks[this.options.mask]){this.setOptions(this.globals.masks[this.options.mask])}if(JSON){this.setOptions(JSON.decode(A,true))}if($type(B)=="object"){this.setOptions(B)}if(this.options.mask){if(this.$el.retrieve("mask")){this.remove()}var C="maxLength",D=this.$el.get(C);this.setOptions({maxlength:D,maskArray:this.options.mask.split(""),maskNonFixedChars:this.options.mask.replace(this.globals.fixedCharsRegG,"")});if(this.$el.get("value")!=""){this.$el.set("value",this.$el.get("value").mask(this.options))}this.$el.store("mask",this).erase(C);this.maskType=new meio.MaskType[this.options.type](this)}return this},remove:function(){var B=this.$el.retrieve("mask");if(B){var A=B.options.maxlength;if(A!=-1){this.$el.set("maxLength",A)}B.maskType.eventsToBind.each(function(C){this.$el.removeEvent(C,this[C+"Event"])}.bind(B.maskType))}return this}});meio.MaskType=new Class({initialize:function(A){this.ignore=false;if(A){this.mask=A;this.globals=A.globals;this.$el=A.$el;this.eventsToBind=["keydown","keypress","keyup","paste"];this.eventsToBind.each(function(B){this[B+"Event"]=this._onMask.bindWithEvent(this,this["_"+B]);this.$el.addEvent(B,this[B+"Event"])}.bind(this))}},_onMask:function(B,A){var C={};B=new Event(B);if(this.$el.get("readonly")){return true}C.value=this.$el.get("value");C.range=this.$el.getRange();C.valueArray=C.value.split("");return A.call(this,B,C)},_keydown:function(B,C){this.ignore=this.globals.ignoreKeys.contains(B.code);if(this.ignore){var A=this.globals.keyRep[B.code];this.mask.fireEvent("valid",[this.$el,A?A:"",B.code])}return Browser.Platform.ipod?this._keypress(B,C):true},_keyup:function(A,B){if(A.code==9&&(Browser.Engine.webkit||Browser.Engine.trident)){return true}return this._paste(A,B)},testEvents:function(A,B,D,C){if(!this.globals.rules[A[B]]){this.mask.fireEvent("overflow",[this.$el,D,C]);return false}else{if(!this.globals.rules[A[B]].test(D)){this.mask.fireEvent("invalid",[this.$el,D,C]);return false}else{this.mask.fireEvent("valid",[this.$el,D,C])}}return true},__mask:function(A){return A.join("")}});meio.MaskType.fixed=new Class({Extends:meio.MaskType,options:{placeHolder:false},_paste:function(A,B){this.$el.set("value",this.__mask(B.valueArray,this.globals,this.mask.options));if(Browser.Engine.trident||Browser.Engine.webkit){this.$el.setRange(B.range.start,B.range.end)}return true},_keypress:function(E,F){if(this.ignore||E.control||E.meta||E.alt){return true}var G=String.fromCharCode(E.code),C=this.mask.options,A=C.maskArray,D=F.value.replace(this.globals.fixedCharsRegG,"").split(""),B=A.__extraPositionsTill(F.range.start,this.globals.fixedCharsReg);F.rsEp=F.range.start+B;if(!this.testEvents(A,F.rsEp,G,E.code)){return false}this.$el.set("value",this.__mask(D,this.globals,C,B));if(F.range.start==F.range.end){if((F.rsEp==0&&F.value.length==0)||F.rsEp<F.value.length){this.$el.setRange(F.rsEp,F.rsEp+1)}}else{this.$el.setRange(F.range.start,F.range.end)}return true},__mask:function(B,C,D,A){return B.__mask(C,D,A).join("").substring(0,D.maskArray.length)}});meio.MaskType.infinite=new Class({Extends:meio.MaskType,_keyup:function(A,B){return true},_paste:function(A,B){this.$el.set("value",this.__mask(B.valueArray,this.globals,this.mask.options));return true},_keypress:function(C,D){if(this.ignore||C.control||C.meta||C.alt){return true}var E=String.fromCharCode(C.code),A=this.mask.options.maskArray,B=D.value.replace(this.globals.fixedCharsRegG,"").split("");if(!this.testEvents(A,0,E,C.code)){return false}this.$el.set("value",B.join(""));return true}});meio.MaskType.reverse=new Class({Extends:meio.MaskType,options:{defaultValue:"",signal:false},initialize:function(B){this.parent(B);if(B){var A=this.mask.options.defaultValue;this.$el.setStyle("text-align","right");if(A!=""&&this.$el.get("value")==""){this.$el.set("value",A.mask(this.mask.options))}}},_paste:function(A,B){this.__changeSignal(A,B);this.$el.set("value",this.__mask(B.valueArray,this.globals,this.mask.options));return true},_keypress:function(H,B){if(this.ignore||H.control||H.meta||H.alt){return true}this.__changeSignal(H,B);var I=String.fromCharCode(H.code),K=B.range.start,F=B.value,A=this.mask.options,D=A.maskArray,E=F.substr(0,K),G=F.substr(B.range.end,F.length);F=(E+I+G);if(A.signal&&(K-A.signal.length>0)){K-=A.signal.length}var J=F.replace(this.globals.fixedCharsRegG,"").split(""),C=D.__extraPositionsTill(K,this.globals.fixedCharsReg);B.rsEp=K+C;if(!this.testEvents(D,B.rsEp,I,H.code)){return false}this.$el.set("value",this.__mask(J,this.globals,A));if(Browser.Engine.trident&&((K==0&&B.range.end==0)||K!=B.range.end)){this.$el.setRange(B.value.length)}return false},__mask:function(B,C,E,A){B.reverse();var D=B.__mask(C,E).reverse();return(E.signal||"")+D.join("").substring(D.length-E.maskArray.length)},__changeSignal:function(B,C){if(this.mask.options.signal!==false){var A=(C.paste)?C.value.charAt(0):B.key;if($defined(this.globals.signals[A])){this.mask.options.signal=this.globals.signals[A]}}}});meio.MaskType.regexp=new Class({Extends:meio.MaskType,initialize:function(A){this.parent(A);this.regExp=new RegExp(this.mask.options.mask)},_keyup:function(A,B){return true},_paste:function(A,B){this.$el.set("value",this.regExp.test(B.value)?B.value:"");return true},_keypress:function(D,E){if(this.ignore||D.control||D.meta||D.alt){return true}var F=String.fromCharCode(D.code),C=E.value,B=C.substr(0,E.range.start),A=C.substr(E.range.end,C.length);C=(B+F+A);if(this.regExp.test(C)){this.mask.fireEvent("valid",[this.$el,F,D.code]);return true}else{this.mask.fireEvent("invalid",[this.$el,F,D.code]);return false}}});Array.implement({__mask:function(B,C,A){this.__removeInvalidChars(C.maskNonFixedChars,B.rules);if(C.defaultValue){this.__applyDefaultValue(C.defaultValue)}this.__applyMask(C.maskArray,B.fixedCharsReg,A);return this},__applyDefaultValue:function(C){var A=C.length,B=this.length,D;for(D=B-1;D>=0;D--){if(this[D]==C.charAt(0)){this.pop()}else{break}}for(D=0;D<A;D++){if(!this[D]){this[D]=C.charAt(D)}}return this},__removeInvalidChars:function(B,C){for(var A=0;A<this.length;A++){if(B.charAt(A)&&C[B.charAt(A)]&&!C[B.charAt(A)].test(this[A])){this.splice(A,1);A--}}return this},__applyMask:function(B,A,D){D=D||0;for(var C=0;C<this.length+D;C++){if(B[C]&&A.test(B[C])){this.splice(C,0,B[C])}}return this},__extraPositionsTill:function(C,A){var B=0;while(A.test(this[C])){C++;B++}return B}});Element.implement({unmaskedVal:function(){return this.get("value").replace(meio.MaskGlobals.init().fixedCharsRegG,"")},mask:function(A){return this.set("mask",A)},setRange:function(C,A){A=$pick(A,C);if(this.setSelectionRange){this.setSelectionRange(C,A)}else{var B=this.createTextRange();B.collapse();B.moveStart("character",C);B.moveEnd("character",A-C);B.select()}},getRange:function(){if(!Browser.Engine.trident){return{start:this.selectionStart,end:this.selectionEnd}}var B={start:0,end:0},A=document.selection.createRange();B.start=0-A.duplicate().moveStart("character",-100000);B.end=B.start+A.text.length;return B}});Element.Properties.mask={set:function(B){B=$pick(B,{});var A=this.retrieve("mask");return this.store("mask",A?A.change(B):new meio.Mask(this,B))},get:function(A){this.set("mask",A);return this.retrieve("mask")},erase:function(){var A=this.retrieve("mask");if(A){A.remove()}return this}};String.implement({mask:function(B){var D=meio.MaskGlobals.init(),F={};switch($type(B)){case"string":if(D.masks[B]){$extend(F,D.masks[B])}else{F.mask=B}break;case"object":$extend(F,B)}if((F.type=="reverse")&&F.defaultValue){var A=D.signals;if(typeof A[F.defaultValue.charAt(0)]!="undefined"){var E=this.charAt(0);F.signal=B.signal=A[E]?A[E]:A[F.defaultValue.charAt(0)];F.defaultValue=B.defaultValue=F.defaultValue.substring(1)}}if(!F.type){F.type="fixed"}var C=new meio.MaskType[F.type];F.maskNonFixedChars=F.mask.replace(D.fixedCharsRegG,"");F.maskArray=F.mask.split("");return C.__mask(this.split(""),D,F)}})